<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AgroSense · Admin</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #0b1220; color: #e9eef7; padding: 16px; min-height: 100vh; }
    :root {
      --logo-w: clamp(240px, 50vw, 520px);
      --c-primary: #4CAF50;
      --btn-radius: 12px;
      --btn-border: rgba(255,255,255,0.14);
    }
    .container { width: 100%; max-width: 1100px; margin: 0 auto; }
    .brand-header { display:flex; align-items:center; justify-content:center; margin: 6px 0 10px; }
    .brand-header img { width: var(--logo-w); max-width: 100%; height: auto; object-fit: contain; display:block; filter: drop-shadow(0 14px 30px rgba(0,0,0,0.55)); }

    .section { background: rgba(22,33,62,0.92); padding: 18px; border-radius: 12px; margin: 14px 0; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 18px 40px rgba(0,0,0,0.30); }
    .section h2 { color: #4CAF50; font-size: 16px; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.10); padding-bottom: 10px; }

    .topbar { display:flex; justify-content:space-between; gap: 10px; flex-wrap: wrap; align-items:center; }
    .pill { display:inline-flex; gap: 8px; align-items:center; padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.10); background: rgba(0,0,0,0.10); font-size: 12px; color:#c9d1d9; }
    .dot { width: 10px; height: 10px; border-radius: 999px; background: #6b7280; box-shadow: 0 0 0 2px rgba(255,255,255,0.08) inset; }
    .dot.ok { background: #22c55e; }
    .dot.bad { background: #ef4444; }

    .mini-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
      border: 1px solid var(--btn-border);
      color: #e9eef7;
      padding: 10px 14px;
      border-radius: var(--btn-radius);
      cursor: pointer;
      font-size: 13px;
      font-weight: 800;
      letter-spacing: .02em;
      box-shadow: 0 12px 26px rgba(0,0,0,0.20);
      transition: transform 0.12s ease, box-shadow 0.18s ease, filter 0.18s ease, background 0.18s ease, border-color 0.18s ease;
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    a.mini-btn { text-decoration: none; }
    .mini-btn:hover { transform: translateY(-1px); box-shadow: 0 16px 34px rgba(0,0,0,0.28); filter: brightness(1.04); }
    .mini-btn:active { transform: translateY(0); filter: brightness(0.98); }
    .mini-btn:focus-visible { outline: 2px solid rgba(76,175,80,0.45); outline-offset: 2px; }
    .mini-btn.primary { border-color: rgba(76,175,80,0.40); color: #d7ffe0; background: linear-gradient(180deg, rgba(76,175,80,0.22), rgba(255,255,255,0.06)); }
    .mini-btn.danger { border-color: rgba(255,77,77,0.35); color: #ffd1d1; background: linear-gradient(180deg, rgba(255,77,77,0.18), rgba(255,255,255,0.06)); }

    .badge { display:inline-flex; align-items:center; justify-content:center; min-width: 18px; height: 18px; padding: 0 6px; border-radius: 999px; font-size: 11px; font-weight: 800; background: rgba(239,68,68,0.95); color: #fff; margin-left: 8px; border: 1px solid rgba(255,255,255,0.20); }
    .badge.hidden { display:none; }

    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .row { display:flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .row label { flex: 0 0 120px; color:#ffffff; font-size: 13px; }
    .row input, .row textarea { flex: 1 1 260px; padding: 10px; border: none; border-radius: 10px; background: #0f3460; color: #fff; font-size: 14px; }
    .row textarea { min-height: 80px; resize: vertical; }

    table { width: 100%; border-collapse: collapse; overflow: hidden; border-radius: 12px; }
    th, td { padding: 10px 10px; border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 13px; text-align:left; vertical-align: top; }
    th { color: #8fa3bf; font-weight: 700; text-transform: uppercase; letter-spacing: .02em; font-size: 11px; background: rgba(15,52,96,0.35); }
    tr:hover td { background: rgba(15,52,96,0.20); }

    .kpi { display:flex; gap: 10px; flex-wrap: wrap; }
    .kpi .card { background: rgba(15,52,96,0.35); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 12px; min-width: 180px; }
    .kpi .k { color:#8fa3bf; font-size: 11px; text-transform: uppercase; }
    .kpi .v { color:#e9eef7; font-size: 22px; font-weight: 800; margin-top: 4px; }

    .status { margin-top: 10px; font-size: 12px; color: #c9d1d9; }
    .status.ok { color: #4CAF50; }
    .status.bad { color: #ff3333; }

    .tag { display:inline-flex; align-items:center; gap: 6px; padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.12); font-size: 12px; }
    .tag.green { border-color: rgba(34,197,94,0.35); color: #b8f5c1; }
    .tag.red { border-color: rgba(239,68,68,0.35); color: #ffb3b3; }

    .muted { color: #8fa3bf; font-size: 12px; }
    .right { display:flex; gap: 10px; flex-wrap: wrap; align-items:center; justify-content:flex-end; }

    .list { display:flex; flex-direction:column; gap: 8px; }
    .item { padding: 10px; border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; background: rgba(15,52,96,0.20); cursor: pointer; }
    .item:hover { background: rgba(15,52,96,0.28); }
    .item-title { font-weight: 800; }
    .item-meta { color: #8fa3bf; font-size: 12px; margin-top: 4px; }

    .messages { border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; background: rgba(0,0,0,0.10); padding: 10px; max-height: 320px; overflow:auto; }
    .msg { padding: 10px; border-radius: 12px; background: rgba(15,52,96,0.22); border: 1px solid rgba(255,255,255,0.06); margin-bottom: 8px; }
    .msg-meta { color:#8fa3bf; font-size: 12px; margin-bottom: 6px; }
    .msg-body { white-space: pre-wrap; }

    @media (max-width: 640px) {
      body { padding: 10px; }
      .section { padding: 14px; }
      .row label { flex: 0 0 100%; }
      .row input, .row textarea { flex: 1 1 100%; }
      th, td { padding: 10px 8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="brand-header">
      <img
        src="/logo-wide.png?v=20260129a"
        srcset="/logo-wide.png?v=20260129a 1x, /logo-wide@2x.png?v=20260129a 2x"
        alt="AgroSense"
        onerror="this.style.display='none'"
      />
    </div>

    <div class="section">
      <div class="topbar">
        <div class="pill" title="Estado admin">
          <span class="dot" id="connDot"></span>
          <span id="connText">Conectando...</span>
        </div>
        <div class="right">
          <button class="mini-btn" id="btnReload" type="button">Recargar</button>
          <button class="mini-btn danger" id="btnLogout" type="button">Salir</button>
        </div>
      </div>
      <div style="height: 12px"></div>
      <div class="kpi" id="kpi"></div>
      <div class="status" id="status">—</div>
    </div>

    <div class="grid">
      <div class="section">
        <h2>CLIENTES</h2>
        <div class="row"><label>ID</label><input id="cId" placeholder="(selecciona un cliente)" disabled /></div>
        <div style="height: 8px"></div>
        <div class="row"><label>Nombre</label><input id="cName" placeholder="Nombre cliente" /></div>
        <div style="height: 8px"></div>
        <div class="row"><label>Email</label><input id="cEmail" placeholder="email@cliente.com" /></div>
        <div style="height: 8px"></div>
        <div class="row"><label>Teléfono</label><input id="cPhone" placeholder="+34 ..." /></div>
        <div style="height: 8px"></div>
        <div class="row"><label>Dirección</label><input id="cAddress" placeholder="Dirección" /></div>
        <div style="height: 8px"></div>
        <div class="row"><label>Notas</label><textarea id="cNotes" placeholder="Notas internas"></textarea></div>
        <div style="height: 10px"></div>
        <div class="right">
          <button class="mini-btn" id="btnClearCustomer" type="button">Limpiar</button>
          <button class="mini-btn primary" id="btnCreateCustomer" type="button">Crear</button>
          <button class="mini-btn primary" id="btnUpdateCustomer" type="button">Guardar cambios</button>
          <button class="mini-btn danger" id="btnDeleteCustomer" type="button">Borrar</button>
        </div>
        <div class="status" id="customerStatus">—</div>

        <div style="height: 10px"></div>
        <div class="muted">Dispositivos del cliente (detalle).</div>
        <div style="height: 8px"></div>
        <div id="customerDevicesList" class="muted" style="display:flex; flex-direction:column; gap: 8px;"></div>
        <div style="height: 12px"></div>
        <div class="muted">Lista (clic para ver detalle y asignar dispositivos).</div>
        <div style="height: 10px"></div>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Contacto</th>
                <th>Dispositivos</th>
              </tr>
            </thead>
            <tbody id="customersTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <h2>DISPOSITIVOS</h2>
        <div class="row"><label>Asignar a</label><input id="assignDeviceCode" placeholder="RIEGO_001" /></div>
        <div style="height: 8px"></div>
        <div class="row"><label>Cliente ID</label><input id="assignCustomerId" placeholder="(clic en un cliente para autollenar)" /></div>
        <div style="height: 10px"></div>
        <div class="right">
          <button class="mini-btn primary" id="btnAssign" type="button">Asignar</button>
          <button class="mini-btn" id="btnUnassign" type="button">Desasignar</button>
        </div>
        <div class="status" id="assignStatus">—</div>
        <div style="height: 12px"></div>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Device</th>
                <th>Cliente</th>
                <th>Última lectura</th>
                <th>Soporte</th>
              </tr>
            </thead>
            <tbody id="devicesTbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>TICKETS <span class="badge hidden" id="adminTicketsBadge">0</span></h2>
      <div class="row">
        <label>Estado</label>
        <select id="tStatus" style="padding: 10px; border: none; border-radius: 10px; background: #0f3460; color: #fff; font-size: 14px;">
          <option value="open">open</option>
          <option value="pending">pending</option>
          <option value="closed">closed</option>
          <option value="">(todos)</option>
        </select>
        <label style="flex: 0 0 120px;">Device</label>
        <input id="tDevice" placeholder="RIEGO_001" />
        <div class="right" style="flex: 1 1 auto; justify-content:flex-end;">
          <button class="mini-btn" id="btnTickets" type="button">Actualizar</button>
        </div>
      </div>
      <div style="height: 10px"></div>
      <div id="ticketsList" class="list"></div>
      <div class="status" id="ticketsStatus">—</div>
    </div>

    <div class="section">
      <h2>DETALLE TICKET</h2>
      <div class="row"><label>ID</label><input id="tId" placeholder="(selecciona un ticket)" disabled /></div>
      <div style="height: 8px"></div>
      <div class="row"><label>Asunto</label><input id="tSubject" placeholder="Asunto" /></div>
      <div style="height: 8px"></div>
      <div class="row">
        <label>Estado</label>
        <select id="tStatusEdit" style="padding: 10px; border: none; border-radius: 10px; background: #0f3460; color: #fff; font-size: 14px;">
          <option value="open">open</option>
          <option value="pending">pending</option>
          <option value="closed">closed</option>
        </select>
        <label style="flex: 0 0 120px;">Prioridad</label>
        <select id="tPriority" style="padding: 10px; border: none; border-radius: 10px; background: #0f3460; color: #fff; font-size: 14px;">
          <option value="low">low</option>
          <option value="normal">normal</option>
          <option value="high">high</option>
        </select>
      </div>
      <div style="height: 8px"></div>
      <div class="row"><label>Cliente</label><input id="tCustomer" placeholder="—" disabled /></div>
      <div style="height: 8px"></div>
      <div class="row"><label>Usuario</label><input id="tUser" placeholder="—" disabled /></div>
      <div style="height: 8px"></div>
      <div class="row"><label>Dispositivo</label><input id="tDeviceView" placeholder="—" disabled /></div>

      <div style="height: 12px"></div>
      <div class="row"><label>Mensajes</label><div id="tMessages" class="messages" style="flex: 1 1 600px;"></div></div>
      <div style="height: 12px"></div>
      <div class="row"><label>Respuesta</label><textarea id="tReply" placeholder="Escribe aquí tu respuesta..."></textarea></div>
      <div style="height: 10px"></div>
      <div class="right">
        <button class="mini-btn primary" id="btnTicketSave" type="button">Guardar</button>
        <button class="mini-btn primary" id="btnTicketReply" type="button">Enviar</button>
        <button class="mini-btn danger" id="btnTicketClose" type="button">Cerrar</button>
      </div>
      <div class="status" id="ticketStatus">—</div>
    </div>
  </div>

  <script>
    const KEY_STORAGE = 'agrosense_admin_key';

    const connDot = document.getElementById('connDot');
    const connText = document.getElementById('connText');
    const statusEl = document.getElementById('status');
    const kpiEl = document.getElementById('kpi');

    const customersTbody = document.getElementById('customersTbody');
    const devicesTbody = document.getElementById('devicesTbody');

    const cId = document.getElementById('cId');
    const cName = document.getElementById('cName');
    const cEmail = document.getElementById('cEmail');
    const cPhone = document.getElementById('cPhone');
    const cAddress = document.getElementById('cAddress');
    const cNotes = document.getElementById('cNotes');
    const customerStatus = document.getElementById('customerStatus');
    const customerDevicesList = document.getElementById('customerDevicesList');

    const assignDeviceCode = document.getElementById('assignDeviceCode');
    const assignCustomerId = document.getElementById('assignCustomerId');
    const assignStatus = document.getElementById('assignStatus');

    const btnReload = document.getElementById('btnReload');
    const btnLogout = document.getElementById('btnLogout');
    const btnClearCustomer = document.getElementById('btnClearCustomer');
    const btnCreateCustomer = document.getElementById('btnCreateCustomer');
    const btnUpdateCustomer = document.getElementById('btnUpdateCustomer');
    const btnDeleteCustomer = document.getElementById('btnDeleteCustomer');
    const btnAssign = document.getElementById('btnAssign');
    const btnUnassign = document.getElementById('btnUnassign');

    const tStatus = document.getElementById('tStatus');
    const tDevice = document.getElementById('tDevice');
    const btnTickets = document.getElementById('btnTickets');
    const ticketsList = document.getElementById('ticketsList');
    const ticketsStatus = document.getElementById('ticketsStatus');
    const adminTicketsBadge = document.getElementById('adminTicketsBadge');

    const tId = document.getElementById('tId');
    const tSubject = document.getElementById('tSubject');
    const tStatusEdit = document.getElementById('tStatusEdit');
    const tPriority = document.getElementById('tPriority');
    const tCustomer = document.getElementById('tCustomer');
    const tUser = document.getElementById('tUser');
    const tDeviceView = document.getElementById('tDeviceView');
    const tMessages = document.getElementById('tMessages');
    const tReply = document.getElementById('tReply');
    const btnTicketSave = document.getElementById('btnTicketSave');
    const btnTicketReply = document.getElementById('btnTicketReply');
    const btnTicketClose = document.getElementById('btnTicketClose');
    const ticketStatus = document.getElementById('ticketStatus');

    let selectedCustomerId = null;
    let selectedTicketId = null;

    function setConn(ok, msg) {
      connDot.className = 'dot ' + (ok ? 'ok' : 'bad');
      connText.textContent = msg;
    }

    function setStatus(el, msg, kind) {
      el.textContent = msg;
      el.className = 'status' + (kind ? ' ' + kind : '');
    }

    function adminKey() {
      return String(localStorage.getItem(KEY_STORAGE) || '').trim();
    }

    async function api(path, opts = {}) {
      const key = adminKey();
      if (!key) throw new Error('Falta ADMIN_KEY. Vuelve a /admin');
      const headers = Object.assign({}, opts.headers || {}, { 'x-admin-key': key });
      if (opts.body && !headers['Content-Type']) headers['Content-Type'] = 'application/json';
      const r = await fetch(path, Object.assign({}, opts, { headers }));
      const text = await r.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }
      if (!r.ok) {
        const msg = data && data.error ? data.error : ('HTTP ' + r.status);
        throw new Error(msg);
      }
      return data;
    }

    function setAdminTicketsBadge(n) {
      if (!adminTicketsBadge) return;
      const count = Math.max(0, Number(n) || 0);
      adminTicketsBadge.textContent = String(count);
      adminTicketsBadge.classList.toggle('hidden', count <= 0);
    }

    async function refreshAdminTicketsBadge() {
      try {
        const j = await api('/api/admin/tickets/unread-count');
        setAdminTicketsBadge(j.unread_count || 0);
      } catch {
        // silencioso
      }
    }

    function fmt(ts) {
      if (!ts) return '—';
      return String(ts);
    }

    function renderKpis(summary) {
      const items = [
        { k: 'Dispositivos', v: summary.devices },
        { k: 'Usuarios', v: summary.users },
        { k: 'Clientes', v: summary.customers }
      ];
      kpiEl.innerHTML = items.map(i => `<div class="card"><div class="k">${i.k}</div><div class="v">${i.v}</div></div>`).join('');
    }

    function renderCustomers(customers) {
      customersTbody.innerHTML = '';
      for (const c of customers) {
        const tr = document.createElement('tr');
        tr.style.cursor = 'pointer';
        tr.innerHTML = `
          <td>
            <div style="font-weight:800">${escapeHtml(c.name)}</div>
            <div class="muted">${escapeHtml(c.id)}</div>
          </td>
          <td>
            <div>${escapeHtml(c.email || '—')}</div>
            <div class="muted">${escapeHtml(c.phone || '')}</div>
          </td>
          <td><span class="tag green">${Number(c.devices_count || 0)}</span></td>
        `;
        tr.addEventListener('click', () => {
          assignCustomerId.value = c.id;
          selectCustomer(c.id);
        });
        customersTbody.appendChild(tr);
      }
    }

    function setCustomerFormEnabled(hasSelection) {
      btnUpdateCustomer.disabled = !hasSelection;
      btnDeleteCustomer.disabled = !hasSelection;
      if (cId) cId.value = hasSelection ? String(selectedCustomerId || '') : '';
    }

    function clearCustomerSelection() {
      selectedCustomerId = null;
      setCustomerFormEnabled(false);
      if (cName) cName.value = '';
      if (cEmail) cEmail.value = '';
      if (cPhone) cPhone.value = '';
      if (cAddress) cAddress.value = '';
      if (cNotes) cNotes.value = '';
      if (assignCustomerId) assignCustomerId.value = '';
      if (customerDevicesList) customerDevicesList.innerHTML = '';
      setStatus(customerStatus, '—', '');
    }

    function renderCustomerDevices(devices) {
      if (!customerDevicesList) return;
      const rows = Array.isArray(devices) ? devices : [];
      if (!rows.length) {
        customerDevicesList.innerHTML = '<span class="tag red">Sin dispositivos</span>';
        return;
      }
      customerDevicesList.innerHTML = '';
      for (const d of rows) {
        const wrap = document.createElement('div');
        wrap.style.display = 'flex';
        wrap.style.alignItems = 'center';
        wrap.style.justifyContent = 'space-between';
        wrap.style.gap = '10px';
        wrap.style.padding = '10px';
        wrap.style.border = '1px solid rgba(255,255,255,0.08)';
        wrap.style.borderRadius = '12px';
        wrap.style.background = 'rgba(15,52,96,0.20)';

        const left = document.createElement('div');
        left.innerHTML = `<div style="font-weight:800">${escapeHtml(d.device_code)}</div><div class="muted">${escapeHtml(d.name || '')}</div>`;

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.gap = '8px';
        right.style.flexWrap = 'wrap';
        right.innerHTML = `
          <a class="mini-btn primary" href="/panel/${encodeURIComponent(String(d.device_code || ''))}" target="_blank" rel="noopener">Abrir</a>
          <button class="mini-btn" type="button" data-unassign="${escapeHtml(d.device_code)}">Desasignar</button>
        `;

        wrap.appendChild(left);
        wrap.appendChild(right);
        customerDevicesList.appendChild(wrap);
      }

      customerDevicesList.querySelectorAll('button[data-unassign]').forEach((btn) => {
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          const dc = String(btn.getAttribute('data-unassign') || '').trim();
          if (!selectedCustomerId || !dc) return;
          setStatus(customerStatus, 'Desasignando...', '');
          try {
            await api(`/api/admin/customers/${encodeURIComponent(selectedCustomerId)}/unassign-device`, {
              method: 'POST',
              body: JSON.stringify({ device_code: dc })
            });
            setStatus(customerStatus, 'Dispositivo desasignado.', 'ok');
            await selectCustomer(selectedCustomerId, true);
            await reloadAll();
          } catch (err) {
            setStatus(customerStatus, err.message || 'Error', 'bad');
          }
        });
      });
    }

    async function selectCustomer(id, silent = false) {
      const cid = String(id || '').trim();
      if (!cid) return;
      selectedCustomerId = cid;
      setCustomerFormEnabled(true);
      if (!silent) setStatus(customerStatus, 'Cargando detalle...', '');
      try {
        const j = await api(`/api/admin/customers/${encodeURIComponent(cid)}`);
        const c = j.customer || {};
        if (cId) cId.value = c.id || cid;
        if (cName) cName.value = c.name || '';
        if (cEmail) cEmail.value = c.email || '';
        if (cPhone) cPhone.value = c.phone || '';
        if (cAddress) cAddress.value = c.address || '';
        if (cNotes) cNotes.value = c.notes || '';
        if (assignCustomerId) assignCustomerId.value = c.id || cid;
        renderCustomerDevices(j.devices || []);
        if (!silent) setStatus(customerStatus, `Seleccionado: ${c.name || cid}`, 'ok');
      } catch (e) {
        if (!silent) setStatus(customerStatus, e.message || 'Error', 'bad');
      }
    }

    function renderDevices(devices) {
      devicesTbody.innerHTML = '';
      for (const d of devices) {
        const tr = document.createElement('tr');
        const customer = d.customer_name ? `<span class="tag green">${escapeHtml(d.customer_name)}</span>` : `<span class="tag red">Sin cliente</span>`;
        tr.innerHTML = `
          <td>
            <div style="font-weight:800">${escapeHtml(d.device_code)}</div>
            <div class="muted">${escapeHtml(d.name || '')}</div>
          </td>
          <td>${customer}</td>
          <td>${escapeHtml(fmt(d.last_seen || d.last_seen_madrid || d.last_seen_madrid_label || '—'))}</td>
          <td>
            <a class="mini-btn primary" href="/panel/${encodeURIComponent(String(d.device_code || ''))}" target="_blank" rel="noopener">Abrir</a>
          </td>
        `;
        devicesTbody.appendChild(tr);
      }
    }

    function renderTicketsList(tickets) {
      const rows = Array.isArray(tickets) ? tickets : [];
      if (!rows.length) {
        ticketsList.innerHTML = '<span class="tag red">Sin tickets</span>';
        return;
      }
      ticketsList.innerHTML = '';
      for (const t of rows) {
        const el = document.createElement('div');
        el.className = 'item';
        if (t.has_unread) el.style.borderColor = 'rgba(239,68,68,0.55)';
        el.innerHTML = `
          <div class="item-title">${escapeHtml(t.subject || '(sin asunto)')}</div>
          <div class="item-meta">
            ${escapeHtml(String(t.status || ''))} · ${escapeHtml(String(t.priority || ''))}
            ${t.device_code ? ' · ' + escapeHtml(t.device_code) : ''}
            ${t.customer_name ? ' · ' + escapeHtml(t.customer_name) : ''}
            ${t.has_unread ? ' · <span class="tag red">NUEVO</span>' : ''}
          </div>
          ${t.last_message ? `<div class="item-meta">${escapeHtml(String(t.last_message)).slice(0, 140)}</div>` : ''}
        `;
        el.addEventListener('click', async () => {
          await selectTicket(t.id);
        });
        ticketsList.appendChild(el);
      }
    }

    function renderTicketMessages(messages) {
      const rows = Array.isArray(messages) ? messages : [];
      if (!rows.length) {
        tMessages.innerHTML = '<div class="muted">Sin mensajes</div>';
        return;
      }
      tMessages.innerHTML = rows.map(m => {
        const who = m.author_type === 'admin' ? 'Admin' : 'Cliente';
        const when = m.created_at_madrid || m.created_at || '';
        return `
          <div class="msg">
            <div class="msg-meta">${escapeHtml(who)} · ${escapeHtml(when)}</div>
            <div class="msg-body">${escapeHtml(m.body)}</div>
          </div>
        `;
      }).join('');
      tMessages.scrollTop = tMessages.scrollHeight;
    }

    function clearTicketSelection() {
      selectedTicketId = null;
      if (tId) tId.value = '';
      if (tSubject) tSubject.value = '';
      if (tCustomer) tCustomer.value = '';
      if (tUser) tUser.value = '';
      if (tDeviceView) tDeviceView.value = '';
      if (tReply) tReply.value = '';
      if (tMessages) tMessages.innerHTML = '<div class="muted">Selecciona un ticket</div>';
      setStatus(ticketStatus, '—', '');
    }

    async function loadTickets() {
      setStatus(ticketsStatus, 'Cargando...', '');
      try {
        const qs = new URLSearchParams();
        const st = String(tStatus.value || '').trim();
        const dc = String(tDevice.value || '').trim();
        if (st) qs.set('status', st);
        if (dc) qs.set('device_code', dc);

        const j = await api(`/api/admin/tickets${qs.toString() ? `?${qs.toString()}` : ''}`);
        renderTicketsList(j.tickets || []);
        setStatus(ticketsStatus, 'Listo.', 'ok');

        await refreshAdminTicketsBadge();

        if (selectedTicketId) {
          await selectTicket(selectedTicketId, true);
        }
      } catch (e) {
        setStatus(ticketsStatus, e.message || 'Error', 'bad');
      }
    }

    async function selectTicket(id, silent = false) {
      const tid = String(id || '').trim();
      if (!tid) return;
      selectedTicketId = tid;
      if (!silent) setStatus(ticketStatus, 'Cargando...', '');
      try {
        const j = await api(`/api/admin/tickets/${encodeURIComponent(tid)}`);
        const t = j.ticket || {};
        if (tId) tId.value = t.id || tid;
        if (tSubject) tSubject.value = t.subject || '';
        if (tStatusEdit) tStatusEdit.value = t.status || 'open';
        if (tPriority) tPriority.value = t.priority || 'normal';
        if (tCustomer) tCustomer.value = t.customer_name || t.customer_id || '';
        if (tUser) tUser.value = t.user_email || t.user_id || '';
        if (tDeviceView) tDeviceView.value = t.device_code || '';
        renderTicketMessages(j.messages || []);
        try { await api(`/api/admin/tickets/${encodeURIComponent(tid)}/mark-read`, { method: 'POST' }); } catch {}
        await refreshAdminTicketsBadge();
        if (!silent) setStatus(ticketStatus, 'Ticket cargado.', 'ok');
      } catch (e) {
        if (!silent) setStatus(ticketStatus, e.message || 'Error', 'bad');
      }
    }

    async function saveTicket() {
      if (!selectedTicketId) return setStatus(ticketStatus, 'Selecciona un ticket.', 'bad');
      setStatus(ticketStatus, 'Guardando...', '');
      try {
        const payload = {
          subject: String(tSubject.value || '').trim(),
          status: String(tStatusEdit.value || '').trim(),
          priority: String(tPriority.value || '').trim()
        };
        await api(`/api/admin/tickets/${encodeURIComponent(selectedTicketId)}`, { method: 'PUT', body: JSON.stringify(payload) });
        setStatus(ticketStatus, 'Guardado.', 'ok');
        await loadTickets();
        await selectTicket(selectedTicketId, true);
      } catch (e) {
        setStatus(ticketStatus, e.message || 'Error', 'bad');
      }
    }

    async function replyTicket() {
      if (!selectedTicketId) return setStatus(ticketStatus, 'Selecciona un ticket.', 'bad');
      const body = String(tReply.value || '').trim();
      if (!body) return setStatus(ticketStatus, 'Escribe una respuesta.', 'bad');
      setStatus(ticketStatus, 'Enviando...', '');
      try {
        await api(`/api/admin/tickets/${encodeURIComponent(selectedTicketId)}/messages`, { method: 'POST', body: JSON.stringify({ body }) });
        tReply.value = '';
        setStatus(ticketStatus, 'Enviado.', 'ok');
        await selectTicket(selectedTicketId, true);
        await loadTickets();
      } catch (e) {
        setStatus(ticketStatus, e.message || 'Error', 'bad');
      }
    }

    async function closeTicket() {
      if (!selectedTicketId) return setStatus(ticketStatus, 'Selecciona un ticket.', 'bad');
      const ok = confirm('¿Seguro que quieres cerrar este ticket?');
      if (!ok) return;
      setStatus(ticketStatus, 'Cerrando...', '');
      try {
        await api(`/api/admin/tickets/${encodeURIComponent(selectedTicketId)}`, { method: 'PUT', body: JSON.stringify({ status: 'closed' }) });
        setStatus(ticketStatus, 'Cerrado.', 'ok');
        await loadTickets();
        await selectTicket(selectedTicketId, true);
      } catch (e) {
        setStatus(ticketStatus, e.message || 'Error', 'bad');
      }
    }

    function escapeHtml(s) {
      return String(s || '').replace(/[&<>\"']/g, (c) => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[c]));
    }

    async function reloadAll() {
      setStatus(statusEl, 'Cargando...', '');
      try {
        const [summary, customers, devices] = await Promise.all([
          api('/api/admin/summary'),
          api('/api/admin/customers'),
          api('/api/admin/devices')
        ]);
        setConn(true, 'Admin OK');
        renderKpis(summary);
        renderCustomers(customers.customers || []);
        renderDevices(devices.devices || []);
        await loadTickets();
        await refreshAdminTicketsBadge();
        setStatus(statusEl, 'Listo.', 'ok');

        if (selectedCustomerId) {
          await selectCustomer(selectedCustomerId, true);
          setStatus(customerStatus, `Seleccionado: ${String(cName.value || selectedCustomerId)}`, 'ok');
        } else {
          setCustomerFormEnabled(false);
        }
      } catch (e) {
        setConn(false, 'Error');
        setStatus(statusEl, e.message || 'Error', 'bad');
      }
    }

    btnReload.addEventListener('click', reloadAll);

    btnTickets.addEventListener('click', loadTickets);
    btnTicketSave.addEventListener('click', saveTicket);
    btnTicketReply.addEventListener('click', replyTicket);
    btnTicketClose.addEventListener('click', closeTicket);

    // Polling ligero: badge de tickets no leídos
    setTimeout(() => { refreshAdminTicketsBadge(); }, 800);
    setInterval(() => { refreshAdminTicketsBadge(); }, 15000);

    btnClearCustomer.addEventListener('click', () => {
      clearCustomerSelection();
    });

    btnLogout.addEventListener('click', () => {
      localStorage.removeItem(KEY_STORAGE);
      fetch('/api/admin/logout', { method: 'POST', credentials: 'include' }).finally(() => {
        window.location.href = '/admin';
      });
    });

    btnCreateCustomer.addEventListener('click', async () => {
      setStatus(customerStatus, 'Creando...', '');
      try {
        const payload = {
          name: String(cName.value || '').trim(),
          email: String(cEmail.value || '').trim() || null,
          phone: String(cPhone.value || '').trim() || null,
          address: String(cAddress.value || '').trim() || null,
          notes: String(cNotes.value || '').trim() || null
        };
        if (!payload.name) return setStatus(customerStatus, 'Falta nombre.', 'bad');
        await api('/api/admin/customers', { method: 'POST', body: JSON.stringify(payload) });
        setStatus(customerStatus, 'Cliente creado.', 'ok');
        cName.value = ''; cEmail.value = ''; cPhone.value = ''; cAddress.value = ''; cNotes.value='';
        clearCustomerSelection();
        await reloadAll();
      } catch (e) {
        setStatus(customerStatus, e.message || 'Error', 'bad');
      }
    });

    btnUpdateCustomer.addEventListener('click', async () => {
      const cid = String(selectedCustomerId || '').trim();
      if (!cid) return setStatus(customerStatus, 'Selecciona un cliente de la lista.', 'bad');
      setStatus(customerStatus, 'Guardando...', '');
      try {
        const payload = {
          name: String(cName.value || '').trim(),
          email: String(cEmail.value || '').trim() || null,
          phone: String(cPhone.value || '').trim() || null,
          address: String(cAddress.value || '').trim() || null,
          notes: String(cNotes.value || '').trim() || null
        };
        if (!payload.name) return setStatus(customerStatus, 'Falta nombre.', 'bad');
        await api(`/api/admin/customers/${encodeURIComponent(cid)}`, { method: 'PUT', body: JSON.stringify(payload) });
        setStatus(customerStatus, 'Cambios guardados.', 'ok');
        await reloadAll();
      } catch (e) {
        setStatus(customerStatus, e.message || 'Error', 'bad');
      }
    });

    btnDeleteCustomer.addEventListener('click', async () => {
      const cid = String(selectedCustomerId || '').trim();
      if (!cid) return setStatus(customerStatus, 'Selecciona un cliente de la lista.', 'bad');
      const ok = confirm('¿Seguro que quieres borrar este cliente?');
      if (!ok) return;
      setStatus(customerStatus, 'Borrando...', '');
      try {
        await api(`/api/admin/customers/${encodeURIComponent(cid)}`, { method: 'DELETE' });
        setStatus(customerStatus, 'Cliente borrado.', 'ok');
        clearCustomerSelection();
        await reloadAll();
      } catch (e) {
        setStatus(customerStatus, e.message || 'Error', 'bad');
      }
    });

    btnAssign.addEventListener('click', async () => {
      setStatus(assignStatus, 'Asignando...', '');
      try {
        const cid = String(assignCustomerId.value || '').trim();
        const dc = String(assignDeviceCode.value || '').trim();
        if (!cid) return setStatus(assignStatus, 'Falta Cliente ID (clic en un cliente).', 'bad');
        if (!dc) return setStatus(assignStatus, 'Falta device_code.', 'bad');
        await api(`/api/admin/customers/${encodeURIComponent(cid)}/assign-device`, { method: 'POST', body: JSON.stringify({ device_code: dc }) });
        setStatus(assignStatus, 'Asignado.', 'ok');
        selectedCustomerId = cid;
        setCustomerFormEnabled(true);
        await reloadAll();
      } catch (e) {
        setStatus(assignStatus, e.message || 'Error', 'bad');
      }
    });

    btnUnassign.addEventListener('click', async () => {
      setStatus(assignStatus, 'Desasignando...', '');
      try {
        const cid = String(assignCustomerId.value || '').trim();
        const dc = String(assignDeviceCode.value || '').trim();
        if (!cid) return setStatus(assignStatus, 'Falta Cliente ID.', 'bad');
        if (!dc) return setStatus(assignStatus, 'Falta device_code.', 'bad');
        await api(`/api/admin/customers/${encodeURIComponent(cid)}/unassign-device`, { method: 'POST', body: JSON.stringify({ device_code: dc }) });
        setStatus(assignStatus, 'Desasignado.', 'ok');
        await reloadAll();
      } catch (e) {
        setStatus(assignStatus, e.message || 'Error', 'bad');
      }
    });

    (function init() {
      const key = adminKey();
      if (!key) {
        window.location.href = '/admin';
        return;
      }
      if (tStatus && !tStatus.value) tStatus.value = 'open';
      clearCustomerSelection();
      clearTicketSelection();
      reloadAll();
    })();
  </script>
</body>
</html>
