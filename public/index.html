<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riego Automatico</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #1a1a2e; color: #eee; padding: 16px; min-height: 100vh; }
        .container { width: 100%; max-width: none; margin: 0; }
        h1 { color: #4CAF50; margin-bottom: 20px; text-align: center; font-size: 28px; }
        .section { background: #16213e; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .section h2 { color: #4CAF50; font-size: 16px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .sensor-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .sensor-card { background: #0f3460; padding: 15px; border-radius: 8px; text-align: center; }
        .sensor-label { font-size: 11px; color: #888; text-transform: uppercase; margin-bottom: 5px; }
        .sensor-value { font-size: 32px; font-weight: bold; color: #4CAF50; }
        .sensor-unit { font-size: 14px; color: #666; }
        .valve-indicator { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 8px; }
        .valve-dot { width: 14px; height: 14px; border-radius: 50%; background: #666; box-shadow: 0 0 10px #000; }
        .valve-dot.on { background: #33cc33; box-shadow: 0 0 18px #33cc33; }
        .valve-dot.off { background: #ff3333; box-shadow: 0 0 18px #ff3333; }
        .valve-text { font-size: 14px; font-weight: bold; color: #ddd; }
        .leds-container { display: flex; justify-content: center; gap: 15px; margin: 20px 0; }
        .led { width: 40px; height: 40px; border-radius: 50%; border: 3px solid #333; transition: all 0.3s; }
        .control-row { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .control-row label { flex: 1; color: #aaa; }
        .control-row input, .control-row select { flex: 2; padding: 10px; border: none; border-radius: 6px; background: #0f3460; color: #fff; font-size: 14px; }
        .control-row input[type="range"] { -webkit-appearance: none; height: 8px; }
        .control-row input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #4CAF50; border-radius: 50%; cursor: pointer; }
        .btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
        .btn { padding: 12px 8px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px; transition: transform 0.1s, opacity 0.2s; }
        .btn:hover { transform: scale(1.05); }
        .btn:active { transform: scale(0.95); }
        .btn-rojo { background: #ff3333; color: white; }
        .btn-verde { background: #33cc33; color: white; }
        .btn-azul { background: #3366ff; color: white; }
        .btn-amarillo { background: #ffcc00; color: black; }
        .btn-cian { background: #00cccc; color: black; }
        .btn-magenta { background: #cc33cc; color: white; }
        .btn-blanco { background: #ffffff; color: black; }
        .btn-off { background: #333; color: #888; }
        .btn-save { background: #4CAF50; color: white; width: 100%; padding: 15px; font-size: 16px; margin-top: 10px; }
        .status { text-align: center; font-size: 12px; color: #666; margin-top: 15px; }
        .status.online { color: #4CAF50; }
        .status.offline { color: #ff3333; }
        .current-color { text-align: center; padding: 10px; background: #0f3460; border-radius: 8px; margin: 10px 0; }
        .current-color span { font-weight: bold; color: #4CAF50; }
        /* Gráficas sin scroll: se ajustan al espacio disponible */
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media (max-width: 900px) {
            .charts-grid { grid-template-columns: 1fr; }
        }
        .chart-box { text-align: left; min-width: 0; }
        .chart-wrap { position: relative; width: 100%; height: clamp(160px, 24vh, 260px); }
        .chart-wrap canvas { width: 100% !important; height: 100% !important; display: block; }
        .btn.active { outline: 2px solid rgba(255,255,255,0.35); opacity: 0.95; }
        .summary { display:flex; justify-content:space-between; gap: 12px; flex-wrap: wrap; margin: 8px 0 0; }
        .summary .k { color: #888; font-size: 11px; text-transform: uppercase; }
        .summary .v { color: #ddd; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1> Riego Automatico ESP32</h1>
        <div class="status" style="margin-bottom: 12px;">UI v2026-01-27</div>

        <div class="section" style="padding: 14px 20px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap: 12px; flex-wrap: wrap;">
                <div>
                    <div class="sensor-label">FECHA / HORA (ESPAÑA)</div>
                    <div style="font-size: 18px; font-weight: bold; color: #ddd;" id="nowEs">--</div>
                </div>
                <div style="display:flex; gap: 10px; align-items:center; flex-wrap: wrap; justify-content:flex-end;">
                    <button class="btn btn-azul" id="btnDia" type="button">DÍA</button>
                    <button class="btn btn-azul" id="btnMes" type="button">MES</button>
                    <button class="btn btn-azul" id="btnAno" type="button">AÑO</button>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2> SENSORES EN TIEMPO REAL</h2>
            <div class="sensor-grid">
                <div class="sensor-card">
                    <div class="sensor-label">Temperatura</div>
                    <div class="sensor-value" id="temp">--</div>
                    <div class="sensor-unit">C</div>
                </div>
                <div class="sensor-card">
                    <div class="sensor-label">Humedad</div>
                    <div class="sensor-value" id="humidity">--</div>
                    <div class="sensor-unit">%</div>
                </div>
                <div class="sensor-card">
                    <div class="sensor-label">Válvula</div>
                    <div class="sensor-value" id="valve">--</div>
                    <div class="valve-indicator">
                        <div class="valve-dot" id="valveDot"></div>
                        <div class="valve-text" id="valveText">--</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2> GRÁFICAS EN TIEMPO REAL</h2>
            <div class="summary">
                <div>
                    <div class="k" id="periodLabel">Periodo</div>
                    <div class="v" id="periodValue">--</div>
                </div>
                <div>
                    <div class="k">Media Humedad</div>
                    <div class="v" id="avgHumidity">--</div>
                </div>
                <div>
                    <div class="k">Tiempo Válvula ON</div>
                    <div class="v" id="totalValveOn">--</div>
                </div>
            </div>
            <div class="charts-grid">
                <div class="sensor-card chart-box">
                    <div class="sensor-label">Humedad del suelo (%)</div>
                    <div class="chart-wrap">
                        <canvas id="humChart"></canvas>
                    </div>
                </div>
                <div class="sensor-card chart-box">
                    <div class="sensor-label">Válvula (ON/OFF) + tiempo activa</div>
                    <div style="display:flex; justify-content:space-between; align-items:center; gap: 10px; margin: 8px 0 6px;">
                        <div class="valve-indicator" style="margin-top: 0; justify-content:flex-start;">
                            <div class="valve-dot" id="valveDotChart"></div>
                            <div class="valve-text" id="valveTextChart">--</div>
                        </div>
                        <div class="sensor-unit" id="valveOnTime">Tiempo ON: --</div>
                    </div>
                    <div class="chart-wrap">
                        <canvas id="valveChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2> CONFIGURACIÓN AUTOMÁTICA</h2>
            <div class="control-row">
                <label>Umbral Humedad Baja:</label>
                <input type="range" id="threshold" min="1" max="100" value="25">
                <span id="thresholdValue" style="width:50px;text-align:right">25%</span>
            </div>
            <div class="control-row">
                <label>Color si Humedad BAJA:</label>
                <select id="colorBuena">
                    <option value="Rojo">Rojo</option>
                    <option value="Verde">Verde</option>
                    <option value="Azul">Azul</option>
                    <option value="Amarillo">Amarillo</option>
                    <option value="Cian">Cian</option>
                    <option value="Magenta">Magenta</option>
                    <option value="Blanco">Blanco</option>
                </select>
            </div>
            <div class="control-row">
                <label>Color si Humedad BUENA:</label>
                <select id="colorBaja">
                    <option value="Rojo">Rojo</option>
                    <option value="Verde" selected>Verde</option>
                    <option value="Azul">Azul</option>
                    <option value="Amarillo">Amarillo</option>
                    <option value="Cian">Cian</option>
                    <option value="Magenta">Magenta</option>
                    <option value="Blanco">Blanco</option>
                </select>
            </div>
            <button class="btn btn-save" onclick="guardar()"> GUARDAR CONFIGURACION</button>
        </div>

        <div class="status" id="status">Conectando...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        let config = { threshold: 25, colorB: 'Rojo', colorG: 'Verde' };

        // --- Zona horaria España (Europe/Madrid) ---
        const TZ = 'Europe/Madrid';
        const fmtNowEs = new Intl.DateTimeFormat('es-ES', {
            timeZone: TZ,
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        });
        const fmtDateEs = new Intl.DateTimeFormat('es-ES', {
            timeZone: TZ,
            year: 'numeric', month: '2-digit', day: '2-digit'
        });

        function getMadridParts(date) {
            const parts = new Intl.DateTimeFormat('sv-SE', {
                timeZone: TZ,
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            }).formatToParts(date);
            const m = Object.fromEntries(parts.map(p => [p.type, p.value]));
            return { y: m.year, mo: m.month, d: m.day, h: m.hour, mi: m.minute };
        }
        function pad2(n) { return String(n).padStart(2, '0'); }
        function formatDuration(ms) {
            const s = Math.floor(ms / 1000);
            const hh = Math.floor(s / 3600);
            const mm = Math.floor((s % 3600) / 60);
            const ss = s % 60;
            if (hh > 0) return `${hh}h ${pad2(mm)}m ${pad2(ss)}s`;
            if (mm > 0) return `${mm}m ${pad2(ss)}s`;
            return `${ss}s`;
        }

        // --- Persistencia ("datos que va recibiendo") ---
        const STORE_KEY = 'riego_stats_v1';
        function loadStore() {
            try {
                const raw = localStorage.getItem(STORE_KEY);
                if (!raw) return { minutes: {}, days: {}, months: {}, last: null };
                const obj = JSON.parse(raw);
                return {
                    minutes: obj.minutes || {},
                    days: obj.days || {},
                    months: obj.months || {},
                    last: obj.last || null
                };
            } catch {
                return { minutes: {}, days: {}, months: {}, last: null };
            }
        }
        function saveStore(store) {
            localStorage.setItem(STORE_KEY, JSON.stringify(store));
        }
        function ensureBucket(map, key) {
            if (!map[key]) map[key] = { humSum: 0, humCount: 0, valveOnMs: 0 };
            return map[key];
        }
        function pruneStore(store) {
            const dayKeys = Object.keys(store.days).sort();
            if (dayKeys.length > 370) {
                for (let i = 0; i < dayKeys.length - 370; i++) delete store.days[dayKeys[i]];
            }
            const monthKeys = Object.keys(store.months).sort();
            if (monthKeys.length > 36) {
                for (let i = 0; i < monthKeys.length - 36; i++) delete store.months[monthKeys[i]];
            }
            // minutes: mantener últimos 2 días (según keys de days)
            const keepDays = new Set(dayKeys.slice(-2));
            const minuteKeys = Object.keys(store.minutes);
            for (const mk of minuteKeys) {
                const dayPart = mk.slice(0, 10);
                if (!keepDays.has(dayPart)) delete store.minutes[mk];
            }
        }
        function ingestSample(store, sampleMs, humidity, valveIsOn) {
            const now = new Date(sampleMs);
            const p = getMadridParts(now);
            const dayKey = `${p.y}-${p.mo}-${p.d}`;
            const monthKey = `${p.y}-${p.mo}`;
            const minuteKey = `${dayKey}T${p.h}:${p.mi}`;

            // Tiempo ON entre muestras (usamos el estado anterior)
            let dt = 0;
            if (store.last && typeof store.last.t === 'number') {
                dt = Math.max(0, sampleMs - store.last.t);
            }
            const prevOn = store.last ? !!store.last.on : false;
            const onMs = prevOn ? dt : 0;

            const bMin = ensureBucket(store.minutes, minuteKey);
            const bDay = ensureBucket(store.days, dayKey);
            const bMonth = ensureBucket(store.months, monthKey);

            bMin.valveOnMs += onMs;
            bDay.valveOnMs += onMs;
            bMonth.valveOnMs += onMs;

            if (!Number.isNaN(humidity)) {
                bMin.humSum += humidity; bMin.humCount += 1;
                bDay.humSum += humidity; bDay.humCount += 1;
                bMonth.humSum += humidity; bMonth.humCount += 1;
            }

            store.last = { t: sampleMs, on: !!valveIsOn };
            pruneStore(store);
            saveStore(store);
        }

        // --- Modo de visualización ---
        let viewMode = 'day'; // day | month | year
        function setActiveModeButtons(mode) {
            document.getElementById('btnDia').classList.toggle('active', mode === 'day');
            document.getElementById('btnMes').classList.toggle('active', mode === 'month');
            document.getElementById('btnAno').classList.toggle('active', mode === 'year');
        }
        setActiveModeButtons(viewMode);

        document.getElementById('btnDia').addEventListener('click', () => { viewMode = 'day'; setActiveModeButtons(viewMode); rebuildCharts(); });
        document.getElementById('btnMes').addEventListener('click', () => { viewMode = 'month'; setActiveModeButtons(viewMode); rebuildCharts(); });
        document.getElementById('btnAno').addEventListener('click', () => { viewMode = 'year'; setActiveModeButtons(viewMode); rebuildCharts(); });

        // --- Datos para Chart.js ---
        const humLabels = [];
        const humSeries = [];
        const valveLabels = [];
        const valveSeries = [];
        function setSeries(labels, series, newLabels, newSeries) {
            labels.length = 0;
            series.length = 0;
            for (const x of newLabels) labels.push(x);
            for (const y of newSeries) series.push(y);
        }

        const humChart = new Chart(document.getElementById('humChart'), {
            type: 'line',
            data: {
                labels: humLabels,
                datasets: [{
                    label: 'Humedad (%)',
                    data: humSeries,
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.15)',
                    fill: true,
                    tension: 0.25,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { min: 0, max: 100, ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.06)' } },
                    x: { ticks: { color: '#888', maxTicksLimit: 6 }, grid: { color: 'rgba(255,255,255,0.04)' } }
                }
            }
        });

        const valveChart = new Chart(document.getElementById('valveChart'), {
            type: 'line',
            data: {
                labels: valveLabels,
                datasets: [{
                    label: 'Válvula (0/1)',
                    data: valveSeries,
                    borderColor: '#33cc33',
                    backgroundColor: 'rgba(51, 204, 51, 0.12)',
                    fill: true,
                    stepped: true,
                    tension: 0,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        min: -0.1,
                        max: 1.1,
                        ticks: {
                            color: '#aaa',
                            callback: (v) => (v >= 0.5 ? 'ON' : 'OFF')
                        },
                        grid: { color: 'rgba(255,255,255,0.06)' }
                    },
                    x: { ticks: { color: '#888', maxTicksLimit: 6 }, grid: { color: 'rgba(255,255,255,0.04)' } }
                }
            }
        });

        function rebuildCharts(storeOpt) {
            const store = storeOpt || loadStore();
            const now = new Date();
            const p = getMadridParts(now);

            let labels = [];
            let hum = [];
            let valve = [];
            let totalHumSum = 0;
            let totalHumCount = 0;
            let totalValveOnMs = 0;

            if (viewMode === 'day') {
                document.getElementById('periodLabel').textContent = 'Día';
                document.getElementById('periodValue').textContent = `${fmtDateEs.format(now)} (últimas 24h)`;

                const entries = Object.entries(store.minutes).sort((a, b) => a[0].localeCompare(b[0]));
                const last = entries.slice(-1440); // 24h * 60
                for (const [k, v] of last) {
                    const avg = v.humCount ? (v.humSum / v.humCount) : null;
                    // Mostrar DD HH:mm para que al cambiar de día se note
                    labels.push(`${k.slice(8, 10)} ${k.slice(11)}`);
                    hum.push(avg === null ? null : Number(avg.toFixed(2)));
                    const duty = Math.max(0, Math.min(1, (v.valveOnMs || 0) / 60000));
                    valve.push(Number(duty.toFixed(2)));
                    totalHumSum += v.humSum || 0;
                    totalHumCount += v.humCount || 0;
                    totalValveOnMs += v.valveOnMs || 0;
                }

                valveChart.options.scales.y.min = -0.1;
                valveChart.options.scales.y.max = 1.1;
                valveChart.options.scales.y.ticks.callback = (v) => (v >= 0.5 ? 'ON' : 'OFF');
                valveChart.data.datasets[0].label = 'Válvula (duty 0..1)';

            } else if (viewMode === 'month') {
                const monthKey = `${p.y}-${p.mo}`;
                document.getElementById('periodLabel').textContent = 'Mes';
                document.getElementById('periodValue').textContent = `${p.mo}/${p.y}`;

                const entries = Object.entries(store.days)
                    .filter(([k]) => k.startsWith(monthKey + '-'))
                    .sort((a, b) => a[0].localeCompare(b[0]));

                for (const [k, v] of entries) {
                    const avg = v.humCount ? (v.humSum / v.humCount) : null;
                    labels.push(k.slice(8, 10));
                    hum.push(avg === null ? null : Number(avg.toFixed(2)));
                    valve.push(Number(((v.valveOnMs || 0) / 3600000).toFixed(2))); // horas
                    totalHumSum += v.humSum || 0;
                    totalHumCount += v.humCount || 0;
                    totalValveOnMs += v.valveOnMs || 0;
                }

                valveChart.options.scales.y.min = 0;
                valveChart.options.scales.y.max = undefined;
                valveChart.options.scales.y.ticks.callback = undefined;
                valveChart.data.datasets[0].label = 'Válvula (horas ON/día)';

            } else {
                const yearKey = `${p.y}-`;
                document.getElementById('periodLabel').textContent = 'Año';
                document.getElementById('periodValue').textContent = `${p.y}`;

                const entries = Object.entries(store.months)
                    .filter(([k]) => k.startsWith(yearKey))
                    .sort((a, b) => a[0].localeCompare(b[0]));

                for (const [k, v] of entries) {
                    const avg = v.humCount ? (v.humSum / v.humCount) : null;
                    labels.push(k.slice(5, 7));
                    hum.push(avg === null ? null : Number(avg.toFixed(2)));
                    valve.push(Number(((v.valveOnMs || 0) / 3600000).toFixed(1))); // horas ON/mes
                    totalHumSum += v.humSum || 0;
                    totalHumCount += v.humCount || 0;
                    totalValveOnMs += v.valveOnMs || 0;
                }

                valveChart.options.scales.y.min = 0;
                valveChart.options.scales.y.max = undefined;
                valveChart.options.scales.y.ticks.callback = undefined;
                valveChart.data.datasets[0].label = 'Válvula (horas ON/mes)';
            }

            const avgHum = totalHumCount ? (totalHumSum / totalHumCount) : null;
            document.getElementById('avgHumidity').textContent = avgHum === null ? '--' : `${avgHum.toFixed(1)}%`;
            document.getElementById('totalValveOn').textContent = totalValveOnMs ? formatDuration(totalValveOnMs) : '--';
            document.getElementById('valveOnTime').textContent = `Tiempo ON (periodo): ${totalValveOnMs ? formatDuration(totalValveOnMs) : '--'}`;

            setSeries(humLabels, humSeries, labels, hum);
            setSeries(valveLabels, valveSeries, labels, valve);
            humChart.update('none');
            valveChart.update('none');

            const valveDotChart = document.getElementById('valveDotChart');
            const valveTextChart = document.getElementById('valveTextChart');
            if (store.last && store.last.on) {
                valveDotChart.className = 'valve-dot on';
                valveTextChart.textContent = 'ENCENDIDA';
            } else if (store.last) {
                valveDotChart.className = 'valve-dot off';
                valveTextChart.textContent = 'APAGADA';
            } else {
                valveDotChart.className = 'valve-dot';
                valveTextChart.textContent = 'SIN DATOS';
            }
        }

        function tickClock() {
            document.getElementById('nowEs').textContent = fmtNowEs.format(new Date());
        }
        tickClock();
        setInterval(tickClock, 1000);

        async function cargarConfig() {
            try {
                const res = await fetch('/api/config/RIEGO_001');
                const cfg = await res.json();

                let threshold = parseFloat(cfg.humidity_low_threshold);
                if (isNaN(threshold) || threshold < 1) threshold = 25;
                if (threshold > 100) threshold = 100;

                config.threshold = threshold;
                config.colorB = cfg.humidity_low_color || 'Rojo';
                config.colorG = cfg.humidity_good_color || 'Verde';

                const thresholdEl = document.getElementById('threshold');
                const thresholdValueEl = document.getElementById('thresholdValue');
                const colorBuenaEl = document.getElementById('colorBuena');
                const colorBajaEl = document.getElementById('colorBaja');

                thresholdEl.value = config.threshold;
                thresholdValueEl.textContent = config.threshold + '%';
                colorBuenaEl.value = config.colorB;
                colorBajaEl.value = config.colorG;
            } catch (e) {
                console.log('Error cargando config');
            }
        }

        document.getElementById('threshold').addEventListener('input', (e) => {
            config.threshold = parseInt(e.target.value);
            document.getElementById('thresholdValue').textContent = config.threshold + '%';
        });

        document.getElementById('colorBuena').addEventListener('change', (e) => {
            config.colorB = e.target.value;
        });

        document.getElementById('colorBaja').addEventListener('change', (e) => {
            config.colorG = e.target.value;
        });

        async function guardar() {
            try {
                const res = await fetch('/api/config/RIEGO_001', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        humidity_low_threshold: config.threshold,
                        humidity_low_color: config.colorB,
                        humidity_good_color: config.colorG
                    })
                });

                if (res.ok) {
                    alert(' Configuracion guardada!\nEl ESP32 aplicara los cambios en 10 segundos.');
                } else {
                    alert(' Error al guardar');
                }
            } catch (e) {
                alert(' Error de conexion');
            }
        }

        async function actualizarSensores() {
            try {
                const res = await fetch('/api/sensor/latest/RIEGO_001');
                const data = await res.json();
                
                document.getElementById('temp').textContent = parseFloat(data.temperature).toFixed(1);
                document.getElementById('humidity').textContent = parseFloat(data.humidity).toFixed(1);

                const rawValve = (data.valve_state || '').toString().toUpperCase();
                const isOn = rawValve === 'ON' || rawValve === '1' || rawValve === 'TRUE';
                const isOff = rawValve === 'OFF' || rawValve === '0' || rawValve === 'FALSE';
                const valveDot = document.getElementById('valveDot');
                const valveText = document.getElementById('valveText');
                const valveValue = document.getElementById('valve');

                if (isOn) {
                    valveDot.className = 'valve-dot on';
                    valveText.textContent = 'ENCENDIDA';
                    valveValue.textContent = 'ON';
                    valveValue.style.color = '#33cc33';
                } else if (isOff) {
                    valveDot.className = 'valve-dot off';
                    valveText.textContent = 'APAGADA';
                    valveValue.textContent = 'OFF';
                    valveValue.style.color = '#ff3333';
                } else {
                    valveDot.className = 'valve-dot';
                    valveText.textContent = 'SIN DATOS';
                    valveValue.textContent = '--';
                    valveValue.style.color = '#aaa';
                }

                // --- Agregar muestra y reconstruir vistas ---
                const now = new Date();
                const nowMs = now.getTime();
                const hum = Number.parseFloat(data.humidity);
                const valveVal = isOn ? 1 : (isOff ? 0 : null);
                const store = loadStore();
                ingestSample(store, nowMs, hum, valveVal === 1);
                rebuildCharts(store);
                
                document.getElementById('status').textContent = ' Online - ' + fmtNowEs.format(new Date());
                document.getElementById('status').className = 'status online';
            } catch(e) {
                document.getElementById('status').textContent = ' Sin conexion';
                document.getElementById('status').className = 'status offline';
            }
        }

        cargarConfig();
        rebuildCharts();
        actualizarSensores();
        setInterval(actualizarSensores, 5000);
    </script>
</body>
</html>
